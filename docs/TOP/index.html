<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODE: SIGMA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .title {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
            color: #4a7ab8;
            text-shadow: 0 0 10px rgba(74, 122, 184, 0.4);
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 30px;
        }

        /* Portrait mode: vertical layout */
        @media (max-aspect-ratio: 1/1) {
            .title {
                text-align: center;
                padding: 20px;
            }

            .main-content {
                flex-direction: column;
            }

            .info-panel {
                text-align: center;
                width: 100%;
            }
        }

        /* Landscape mode: horizontal layout */
        @media (min-aspect-ratio: 1/1) {
            body {
                flex-direction: row;
            }

            .title {
                position: fixed;
                top: 20px;
                left: 20px;
            }

            .main-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 80px 40px 40px 40px;
            }

            .info-panel {
                flex: 0 0 300px;
                text-align: left;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .quiz-grid-container {
                flex: 1;
                max-width: 600px;
            }
        }

        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .quiz-grid-container {
            width: 600px;
            height: 600px;
            background-color: #0f0f0f;
            border: 2px solid #4a7ab8;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(74, 122, 184, 0.15);
        }

        .quiz-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(40, 1fr);
            grid-template-rows: repeat(40, 1fr);
            position: relative;
        }

        .grid-cell {
            border: 1px solid #1a1a1a;
            box-sizing: border-box;
        }

        .grid-cell:hover {
            background-color: rgba(74, 122, 184, 0.1);
        }

        .center-axis {
            position: absolute;
            background-color: rgba(74, 122, 184, 0.3);
            pointer-events: none;
        }

        .axis-x {
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
        }

        .axis-y {
            width: 1px;
            height: 100%;
            left: 50%;
            top: 0;
        }

        .shape {
            position: absolute;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }

        .shape-rect {
            background-color: #4a7ab8;
            border: 1px solid #5a8ac8;
        }

        .shape-circle {
            background-color: #4a7ab8;
            border: 1px solid #5a8ac8;
            border-radius: 50%;
        }

        .shape-outline {
            background-color: transparent !important;
        }

        .shape-filled {
            border-color: transparent !important;
        }

        .shape-image {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: none;
        }

        .shape-triangle {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid #4a7ab8;
            transform: none;
        }

        .coordinate-display {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.8rem;
            color: #4a7ab8;
            font-family: monospace;
        }

        .caption {
            max-width: 800px;
            font-size: 1.1rem;
            line-height: 1.6;
            color: #cccccc;
        }

        .answer-input-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .answer-input {
            padding: 10px 15px;
            background-color: #2a2a2a;
            border: 1px solid #4a7ab8;
            border-radius: 5px;
            color: #ffffff;
            font-size: 1rem;
            width: 200px;
            text-align: center;
        }

        .answer-input:focus {
            outline: none;
            border-color: #5a8ac8;
            box-shadow: 0 0 10px rgba(74, 122, 184, 0.3);
        }

        .submit-btn {
            padding: 10px 20px;
            background-color: #4a7ab8;
            border: none;
            border-radius: 5px;
            color: #ffffff;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .submit-btn:hover {
            background-color: #5a8ac8;
        }

        .feedback {
            margin-top: 15px;
            font-size: 1rem;
            text-align: center;
        }

        .feedback.correct {
            color: #4ab84a;
        }

        .feedback.incorrect {
            color: #b84a4a;
        }

        .grid-clickable {
            cursor: pointer;
        }

        .grid-clickable.disabled {
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn {
            padding: 10px 20px;
            background-color: #4a7ab8;
            border: none;
            border-radius: 5px;
            color: #ffffff;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #5a8ac8;
        }

        .btn-secondary {
            background-color: #3a3a3a;
        }

        .btn-secondary:hover {
            background-color: #4a4a4a;
        }

        /* List view styles */
        .quiz-list-container {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .quiz-list-container.active {
            display: block;
        }

        .quiz-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .quiz-item {
            background-color: #2a2a2a;
            border: 2px solid #4a7ab8;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-item:hover {
            background-color: #3a3a3a;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 122, 184, 0.3);
        }

        .quiz-item.completed {
            border-color: #4ab84a;
            opacity: 0.7;
        }

        .quiz-item-index {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a7ab8;
            margin-bottom: 10px;
        }

        .quiz-item-caption {
            font-size: 0.9rem;
            color: #cccccc;
            line-height: 1.4;
        }

        .quiz-view-container {
            display: flex;
        }

        .quiz-view-container.hidden {
            display: none;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="title">CODE: SIGMA</div>

    <!-- Quiz List View -->
    <div class="quiz-list-container active" id="quizListContainer">
        <div class="quiz-list" id="quizList">
            <!-- Quiz items will be generated by JavaScript -->
        </div>
    </div>

    <!-- Quiz View -->
    <div class="main-content quiz-view-container hidden" id="quizViewContainer">
        <div class="info-panel">
            <div class="caption" id="caption">
                Loading quiz...
            </div>
            <div class="feedback" id="feedback"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" id="backToListBtn">목록으로</button>
            </div>
        </div>
        <div class="quiz-grid-container">
            <div class="center-axis axis-x"></div>
            <div class="center-axis axis-y"></div>
            <div class="quiz-grid" id="quizGrid">
                <!-- Grid cells will be generated by JavaScript -->
            </div>
            <div class="coordinate-display" id="coordinateDisplay">(0, 0)</div>
        </div>
    </div>

    <script>
        const grid = document.getElementById('quizGrid');
        const coordinateDisplay = document.getElementById('coordinateDisplay');
        const caption = document.getElementById('caption');
        const feedback = document.getElementById('feedback');
        const titleElement = document.querySelector('.title');
        const quizListContainer = document.getElementById('quizListContainer');
        const quizViewContainer = document.getElementById('quizViewContainer');
        const quizList = document.getElementById('quizList');
        const backToListBtn = document.getElementById('backToListBtn');
        const gridSize = 40;
        const halfGrid = gridSize / 2;

        let quizData = null;
        let currentQuizSet = null;
        let currentQuiz = null;
        let currentIndex = 1;
        let usedQuizIds = new Set();
        let completedIndices = new Set();
        let isAnswering = true; // Block clicks during feedback

        // Load quiz data from JSON
        async function loadQuizData() {
            try {
                const response = await fetch('quiz-data.json');
                quizData = await response.json();

                // Show quiz set list
                renderQuizList();
            } catch (error) {
                console.error('Failed to load quiz data:', error);
                quizList.innerHTML = '<p style="text-align: center; color: #ff6666;">Failed to load quiz data.</p>';
            }
        }

        // Render quiz list (quiz sets)
        function renderQuizList() {
            quizList.innerHTML = '';

            quizData.quizSets.forEach(quizSet => {
                const item = document.createElement('div');
                item.className = 'quiz-item';
                if (completedIndices.has(quizSet.id)) {
                    item.classList.add('completed');
                }

                item.innerHTML = `
                    <div class="quiz-item-index">${quizSet.title}</div>
                `;

                item.addEventListener('click', () => {
                    startQuizSet(quizSet);
                });

                quizList.appendChild(item);
            });
        }

        // Show quiz list view
        function showQuizList() {
            quizListContainer.classList.add('active');
            quizViewContainer.classList.add('hidden');
            titleElement.textContent = quizData.quizSets[0].title.split(' ')[0] + ' SERIES';
            renderQuizList();
        }

        // Show quiz view
        function showQuizView() {
            quizListContainer.classList.remove('active');
            quizViewContainer.classList.remove('hidden');
        }

        // Start a quiz set
        function startQuizSet(quizSet) {
            currentQuizSet = quizSet;
            currentIndex = 1;
            usedQuizIds.clear();
            completedIndices.clear();
            showQuizView();
            titleElement.textContent = quizSet.title;
            loadQuizByIndex(1);
        }

        // Get all quizzes with a specific index from current quiz set
        function getQuizzesByIndex(index) {
            return currentQuizSet.quizzes.filter(q => q.index === index);
        }

        // Load a quiz by index (random selection if multiple)
        function loadQuizByIndex(index) {
            const quizzes = getQuizzesByIndex(index);

            if (quizzes.length === 0) {
                // No more quizzes - go back to list
                showQuizList();
                return;
            }

            // Randomly select from available quizzes
            const availableQuizzes = quizzes.filter(q => !usedQuizIds.has(JSON.stringify(q)));

            if (availableQuizzes.length === 0) {
                // All quizzes at this index have been used, reset and allow replay
                usedQuizIds.clear();
                currentQuiz = quizzes[Math.floor(Math.random() * quizzes.length)];
            } else {
                currentQuiz = availableQuizzes[Math.floor(Math.random() * availableQuizzes.length)];
            }

            usedQuizIds.add(JSON.stringify(currentQuiz));

            renderQuiz(currentQuiz);
        }

        // Render a quiz
        function renderQuiz(quiz) {
            // Clear previous shapes (keep grid cells)
            const shapes = grid.querySelectorAll('.shape');
            shapes.forEach(shape => shape.remove());

            // Clear feedback
            feedback.textContent = '';
            feedback.className = 'feedback';

            // Enable answering
            isAnswering = true;
            updateGridClickability();

            // Set caption
            caption.textContent = quiz.caption;

            // Render shapes
            if (quiz.shapes) {
                quiz.shapes.forEach(shapeData => {
                    placeShape(
                        shapeData.x,
                        shapeData.y,
                        shapeData.width,
                        shapeData.height,
                        shapeData.type,
                        shapeData.fillMode,
                        shapeData.imageUrl || '',
                        shapeData.zIndex || 0
                    );
                });
            }
        }

        // Update grid clickability
        function updateGridClickability() {
            const cells = grid.querySelectorAll('.grid-cell');
            cells.forEach(cell => {
                if (isAnswering) {
                    cell.classList.remove('disabled');
                } else {
                    cell.classList.add('disabled');
                }
            });
        }

        // Check answer based on click position
        function checkAnswer(x, y) {
            if (!isAnswering || !currentQuiz || !currentQuiz.answer) return;

            const answer = currentQuiz.answer;
            const distance = Math.sqrt(
                Math.pow(x - answer.x, 2) + Math.pow(y - answer.y, 2)
            );

            if (distance <= answer.tolerance) {
                // Correct!
                isAnswering = false;
                updateGridClickability();

                feedback.textContent = '정답입니다!';
                feedback.className = 'feedback correct';

                completedIndices.add(currentIndex);

                setTimeout(() => {
                    currentIndex++;
                    loadQuizByIndex(currentIndex);
                }, 1500);
            } else {
                // Incorrect - restart from index 1
                isAnswering = false;
                updateGridClickability();

                feedback.textContent = '틀렸습니다. 1번으로 돌아갑니다.';
                feedback.className = 'feedback incorrect';

                // Clear all progress
                completedIndices.clear();
                usedQuizIds.clear();

                setTimeout(() => {
                    // Go back to index 1
                    currentIndex = 1;
                    loadQuizByIndex(1);
                }, 2000);
            }
        }

        // Generate grid cells
        for (let y = 0; y < gridSize; y++) {
            for (let x = 0; x < gridSize; x++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell grid-clickable';
                cell.dataset.x = x;
                cell.dataset.y = y;

                cell.addEventListener('mouseenter', () => {
                    // Convert to center-based coordinates
                    const gridX = x - halfGrid + 1;
                    const gridY = halfGrid - y;
                    coordinateDisplay.textContent = `(${gridX}, ${gridY})`;
                });

                cell.addEventListener('click', () => {
                    // Convert to center-based coordinates
                    const gridX = x - halfGrid + 1;
                    const gridY = halfGrid - y;
                    checkAnswer(gridX, gridY);
                });

                grid.appendChild(cell);
            }
        }

        // Function to place a shape at grid coordinates
        // x, y: center-based coordinates (-20 to 19)
        // width, height: number of cells
        // type: 'rect', 'circle', 'triangle'
        // fillMode: 'outline' (border only), 'filled' (solid), 'image' (image fill)
        // imageUrl: URL for image when fillMode is 'image'
        // zIndex: z-index value (default 0)
        function placeShape(x, y, width, height, type = 'rect', fillMode = 'filled', imageUrl = '', zIndex = 0) {
            const cellWidth = grid.offsetWidth / gridSize;
            const cellHeight = grid.offsetHeight / gridSize;

            // Convert center-based coordinates to pixel position (true center)
            const pixelX = (x + halfGrid) * cellWidth;
            const pixelY = (halfGrid - y) * cellHeight;

            const shape = document.createElement('div');
            shape.className = `shape shape-${type}`;

            // Apply fill mode
            if (fillMode === 'outline') {
                shape.classList.add('shape-outline');
            } else if (fillMode === 'filled') {
                shape.classList.add('shape-filled');
            } else if (fillMode === 'image' && imageUrl) {
                shape.classList.add('shape-image');
                shape.style.backgroundImage = `url('${imageUrl}')`;
            }

            shape.style.left = `${pixelX}px`;
            shape.style.top = `${pixelY}px`;
            shape.style.width = `${width * cellWidth}px`;
            shape.style.height = `${height * cellHeight}px`;
            shape.style.zIndex = zIndex;

            grid.appendChild(shape);
        }

        // Back to list button
        backToListBtn.addEventListener('click', () => {
            showQuizList();
        });

        // Initialize quiz
        loadQuizData();
    </script>
</body>
</html>
